# 脚本语法

**脚本语法由一系列HA将执行的动作构成。脚本可以通过独立的脚本集成作为实体提供，也可以自动嵌入到自动化和Alexa/amazon echo配置中。**

当脚本在自动化中执行的时候，可以访问触发器变量。详情参阅可用的触发器变量。



## 语法

脚本语法的基本结构是一个包含动作的键值映射列表。当脚本中只有一个动作时候，可以省略包装列表。

所有的动作（`action`）都可以有一个别名(`alias`)的可选项，便于理解。

```yml
# Example script integration containing script syntax
script:
  example_script:
    sequence:
      # This is written using the Script Syntax
      - alias: "Turn on ceiling light"
        action: light.turn_on
        target:
          entity_id: light.ceiling
      - alias: "Notify that ceiling light is turned on"
        action: notify.notify
        data:
          message: "Turned on the ceiling light!"
```



## 执行动作

可以通过多种方式执行一个动作。所有的可执行方法，参阅[动作执行](https://www.home-assistant.io/docs/scripts/perform-actions/)。

```yml
- alias: "Bedroom lights on"
  action: light.turn_on
  target:
    entity_id: group.bedroom
  data:
    brightness: 100
```

### 激活场景

脚本还可以使用快捷语法来激活场景（scene），而不是调用` scene.turn_on action`。

```
- scene: scene.morning_living_room
```

## 变量动作

变量相关动作允许你为变量赋值，该变量会在之后的动作中被访问。查阅[脚本变量](https://www.home-assistant.io/integrations/script/#configuration-variables)以知晓如何定义整个脚本均可访问的变量。

```yml
- alias: "Set variables"
  variables:
    entities:
      - light.kitchen
      - light.living_room
    brightness: 100
- alias: "Control lights"
  action: light.turn_on
  target:
    entity_id: "{{ entities }}"
  data:
    brightness: "{{ brightness }}"
```

可以使用模板处理变量

```yml
- alias: "Set a templated variable"
  variables:
    blind_state_message: "The blind is {{ states('cover.blind') }}."
- alias: "Notify about the state of the blind"
  action: notify.mobile_app_iphone
  data:
    message: "{{ blind_state_message }}"
```

### 变量的作用域

这个变量动作可以让你为之前定义的同名的脚本变量重新赋值。如果这个变量之前没有定义，它将在顶级 (脚本运行) 作用域中分配。

```yml
sequence:
  # Set the people variable to a default value
  - variables:
      people: 0
  # Try to increment people if Paulus is home
  - if:
      - condition: state
        entity_id: device_tracker.paulus
        state: "home"
    then:
      - variables:
          people: "{{ people + 1 }}"
          paulus_home: true
      - action: notify.notify
        data:
          message: "There are {{ people }} people home" # "There are 1 people home"
  # Variable value is now updated
  - action: notify.notify
    data:
      message: "There are {{ people }} people home {% if paulus_home is defined %}(including Paulus){% endif %}"
      # "There are 1 people home (including Paulus)"
```

## 条件判断

在执行脚本的时候你可以添加一个条件判断语句来终端后序的的脚本动作执行。当条件不符合的时候，脚本将停止运行。查阅不同的条件参考[条件页面](https://www.home-assistant.io/docs/scripts/conditions/)

```


The condition action only stops executing the current sequence block. When it is used inside a repeat action, only the current iteration of the repeat loop will stop. When it is used inside a choose action, only the actions within that choose will stop.
```

<div class="note">
  <strong>ℹ️  请注意</strong><br>
  条件判断动作只能退出当前sequence块中的语句. 当它在`repeat动作中被使用时，只会退出本次循环，当在`choose`动作中使用时，只会退出条件判断语句所在的choose语句。
</div>

```yml
- alias: "Check if Paulus is home"
  condition: state
  entity_id: device_tracker.paulus
  state: "home"
```

条件也可以是一个列表，只有当所有条件都符合返回 true 时，执行才会继续。

```yml
- alias: "Check if Paulus ishome AND temperature is below 20"
  conditions:
    - condition: state
      entity_id: "device_tracker.paulus"
      state: "home"
    - condition: numeric_state
      entity_id: "sensor.temperature"
      below: 20
```

### 等待一段时间后通过（延时）

延时`delay`对于暂停脚本并在稍后重新启动非常有用。HA支持不同的延时语法。

```
# Seconds
# Waits 5 seconds
- alias: "Wait 5s"
  delay: 5
```

```
# HH:MM
# Waits 1 hour
- delay: "01:00"
```

```
# HH:MM:SS
# Waits 1.5 minutes
- delay: "00:01:30"
```

```
# 支持毫秒，秒，分钟，小时，天的设置
# 可以混合使用
# 当使用毫秒时，将延迟考虑为 * 至少 * X 毫秒。这不会是精确的。
- delay:
    minutes: 1
```

`delay`支持模板语法

```yml
# Waits however many minutes input_number.minute_delay is set to
- delay: "{{ states('input_number.minute_delay') | multiply(60) | int }}"
```

## 等待

下列操作允许脚本等待系统中的实体处于模板指定的特定状态，或者等待一个或多个触发器表示的某个事件的发生。

###  wait_template

每当模板引用的实体 ID 发生状态变化时，模板都会重新评估。如果你在模板中使用非确定性函数，如 now (), 模板不会持续重新评估，而只会在引用的实体 ID 发生变化时重新评估。如果你需要定期重新评估模板，请参考[时间和日期集成](https://www.home-assistant.io/integrations/time_date/)中每分钟或每天会自动更新更新的传感器。

```yml
# 等待音乐停止
- alias: "Wait until media player is stopped"
  wait_template: "{{ is_state('media_player.floor', 'stop') }}"
```

### 等待触发器

该操作可以使用和自动化触发器部分trigger`。无论何时触发任何触发器，脚本都会继续自学。所有先前定义的触发器变量、普通变量和脚本变量都会传递给触发器使用。

```yml
# Wait for a custom event or light to turn on and stay on for 10 sec
- alias: "Wait for MY_EVENT or light on"
  wait_for_trigger:
    - trigger: event
      event_type: MY_EVENT
    - trigger: state
      entity_id: light.LIGHT
      to: "on"
      for: 10
```

## 等待超时（Wait timeout）

该等待有两种形式，这两种形式在等待时间结束后，如果条件不满足，脚本将继续执行。`Wait timeout`的语法与`delay`相同，二者均接受模板。

```yml
 Wait for sensor to change to 'on' up to 1 minute before continuing to execute.
- wait_template: "{{ is_state('binary_sensor.entrance', 'on') }}"
  timeout: "00:01:00"
```

那样可以使用选项`continue_on_timeout: false`使得脚本在时间结束后退出执行。

无 `continue_on_timeout:false` 的脚本将始终继续，因为 continue_on_timeout 的默认值为 true。

### 等待变量 (Wait variable )

才每次等待结束后，无论条件是否符合，事件是否发生，是否超时，变量`wait`都会自动更新来展示结果。（参考触发器中的trigger，this，这些变量都是系统自动创建的变量，为了方便获取程序执行过程中的值。）

| Variable         | Description                                                  |
| :--------------- | :----------------------------------------------------------- |
| `wait.completed` | 条件符合返回true，否则返回false                              |
| `wait.remaining` | 等待剩余的时间，如果等待时间没有指定就返回none               |
| `wait.trigger`   | 仅在 wait_for_trigger 之后存在。包含关于触发了哪个触发器的信息。(请参阅可用触发器数据) 如果在超时到期前没有触发器发生，则为零。 |